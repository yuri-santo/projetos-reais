<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulário CEMIG</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <header class="epr">
    <div class="position-relative text-center my-4">
      <img src="{{ url_for('static', filename='img/logo_max.png') }}" alt="Logo da empresa" class="position-absolute top-0 start-0 img-fluid logo-empresa ms-3 mt-2">
      <h2 class="mb-0">Formulário de acompanhamento de chamado da CEMIG</h2>
      
    </div>
  </header>

  <main class="epr_conteudo">
    <div class="container my-5">
      {% if success %}
      <div id="success-alert" class="alert alert-success alert-dismissible fade show" role="alert" style="opacity: 0;">
        Registro enviado com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
      {% endif %}

      <form method="POST" action="/" class="row g-3" id="formChamado">
        <div class="col-md-6">
          <label for="chamado" class="form-label">Número do chamado</label>
          <input type="text" class="form-control" id="chamado" name="chamado" required />
        </div>

        <div class="col-md-6">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status" required>
            <option value="" disabled selected>Selecione</option>
            <!-- valores mantidos -->
            <option value="Em andamento">Em andamento</option>
            <option value="Encerrada">Encerrada</option>
            <option value="Aberta">Aberta</option>
            </select>
        </div>

        <div class="col-md-6">
          <label for="localidade" class="form-label">Localidade</label>
          <select class="form-select" id="localidade" name="localidade" required>
            <option value="" disabled selected>Selecione</option>
            <option value="PP - 01">PP - 01</option>
            <option value="PP - 10">PP - 10</option>
            <option value="PP - 11">PP - 11</option>
            <option value="BSO - 01">BSO - 01</option>
            <option value="SAU - 18">SAU - 18</option>
            <option value="SAU - 19">SAU - 19</option>
            <option value="SAU - 20">SAU - 20</option>
            <option value="SAU - 21">SAU - 21</option>
            <option value="Balança  Carandaí">Balança  Carandaí</option>
            <option value="RPT - 13">RPT - 13</option>
            <option value="RPT - 14">RPT - 14</option>
            <option value="RPT - 15">RPT - 15</option>
            <option value="RPT - 16">RPT - 16</option>
            <option value="RPT - 18">RPT - 18</option>
            <option value="RPT- 17Corr almeida">Corralmeida</option>
            <option value="RDATA 14.1">RDATA 14.1</option>
            <option value="RDATA 14.2">RDATA 14.2</option>
            <option value="RDATA 14.3">RDATA 14.3</option>
            <option value="RDATA 16.1">RDATA 16.1</option>
            <option value="RDATA 17">RDATA 17</option>
            <option value="RDATA 18">RDATA 18</option>
            <option value="RDATA - PP10">RDATA - PP10</option>
            <option value="PMV - 07">PMV - 07</option>
            <option value="PMV - 08">PMV - 08</option>
            <option value="PMV - 09">PMV - 09</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="n_medidor" class="form-label">N° Medidor</label>
          <select class="form-select" id="n_medidor" name="n_medidor" required>
            <option value="" disabled selected>Selecione</option>
            <!-- valores mantidos -->
            {% for medidor in [
              "GMG126000404", "GMI064000091", "GMJ155000344", "ARC164006153",
              "APD167055614", "CAA137000001", "APD167028493", "APD159029525",
              "ARB145005973", "APD159004232", "APD167055651", "AJK134033756",
              "APC149056194", "APD159056317", "APD175093880", "APD142057967",
              "APD159025558", "APD159124025", "APD142013904", "APD159067285",
              "APD1590563227", "APD159070514", "APD159095218", "APD159038825",
              "AJK134033824", "AJK134032068"
            ] %}
            <option value="{{ medidor }}">{{ medidor }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label for="uc_instalacao" class="form-label">UC/Instalação</label>
          <select class="form-select" id="uc_instalacao" name="uc_instalacao" required>
            <option value="" disabled selected>Selecione</option>
            {% for uc in [
              "3003271107", "3012424498", "3012561397", "3012569128", "3012570697", "3012573851",
              "3012586666", "3012588531", "3012656251", "3012667837", "3012699982", "3012712558",
              "3012712647", "3012724708", "3012724735", "3012724772", "3012730204", "3012740719",
              "3012757198", "3012795862", "3012917317", "3012926204", "3012975588", "3012991579",
              "3013057398", "3013190398", "3013653187"
            ] %}
            <option value="{{ uc }}">{{ uc }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label for="responsavel" class="form-label">Responsável pela ligação</label>
          <input type="text" class="form-control" id="responsavel" name="responsavel" required />
        </div>

        <div class="col-md-6">
          <label for="descricao" class="form-label">Descrição</label>
          <textarea class="form-control" id="descricao" name="descricao" rows="3" placeholder="Descreva detalhes da localidade"></textarea>
        </div>

        <div class="col-12 text-center">
          <button type="submit" class="btn btn-primary px-5">Enviar</button>
        </div>
      </form>

      <hr class="my-5" />
      <h2 class="text-center">Lista de Chamados Registrados</h2>

      <div class="mb-3">
      <label for="filtroChamado" class="form-label">Filtrar por Localidade:</label>
      <select id="filtroChamado" class="form-select" onchange="filtrarChamado()">
        <option value="" selected disabled>Selecione uma localidade</option>
        {% for loc in localidades %}
            <option value="{{ loc }}">{{ loc }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="tabelaChamados" style="display: none;">
        <thead class="table-success">
          <tr>
            <th>Chamado</th>
            <th>Data/Hora</th>
            <th>Status</th>
            <th>Localidade</th>
            <th>N° Medidor</th>
            <th>UC/Instalação</th>
            <th>Responsável pela ligação</th>
            <th>Descrição</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for row in chamados %}
          <tr data-localidade="{{ row['localidade'] }}">
              <td>{{ row['data_hora'] }}</td>
              <td>{{ row['chamado'] }}</td>
              <td>{{ row['localidade'] }}</td>
              <td>{{ row['n_medidor'] }}</td>
              <td>{{ row['uc_instalacao'] }}</td>
              <td>{{ row['responsavel'] }}</td>
              <td>{{ row['descricao'] }}</td>
              <td>{{ row['status'] }}</td>
              <td>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditar{{ row['id'] }}">
                  Editar
                </button>
              </td>
          </tr>
          <div class="modal fade" id="modalEditar{{ row['id'] }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content modal-content-glass">
                <div class="modal-header">
                  <h5 class="modal-title">Editar Chamado</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <form method="post" action="{{ url_for('editar_chamado', id=row['id']) }}">
                    <label>Chamado:</label>
                    <input type="text" name="chamado" value="{{ row['chamado'] }}" class="form-control mb-2" required>

                    <label>Localidade:</label>
                    <input type="text" name="localidade" value="{{ row['localidade'] }}" class="form-control mb-2">

                    <label>Nº Medidor:</label>
                    <input type="text" name="n_medidor" value="{{ row['n_medidor'] }}" class="form-control mb-2">

                    <label>UC Instalação:</label>
                    <input type="text" name="uc_instalacao" value="{{ row['uc_instalacao'] }}" class="form-control mb-2">

                    <label>Responsável:</label>
                    <input type="text" name="responsavel" value="{{ row['responsavel'] }}" class="form-control mb-2">

                    <label>Descrição:</label>
                    <textarea name="descricao" class="form-control mb-2">{{ row['descricao'] }}</textarea>

                    <label>Status:</label>
                    <input type="text" name="status" value="{{ row['status'] }}" class="form-control mb-3">

                    <button type="submit" class="btn btn-success w-100">Salvar</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
      </tbody>
      </table>
    </div>
    
  </main>

  <footer class="text-center py-3">
    <span class="text-muted">Grupo EPR <br> Via Mineira <br> © {{ now.year }}</span>
  </footer>


 <script>
  function filtrarChamado() {
    var filtro = document.getElementById('filtroChamado').value;
    var linhas = document.querySelectorAll('#tabelaChamados tbody tr');
    var tabela = document.getElementById('tabelaChamados');

    if (!filtro) {
      tabela.style.display = 'none';
      return;
    }

    tabela.style.display = ''; // Mostra a tabela quando tem filtro

    linhas.forEach(function(linha) {
      var localidade = linha.getAttribute('data-localidade');
      if (!filtro || localidade === filtro) {
        linha.style.display = '';
      } else {
        linha.style.display = 'none';
      }
    });
  }
  </script>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
